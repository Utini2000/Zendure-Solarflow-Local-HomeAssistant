################################################################################
#                   ZENDURE SOLARFLOW CONTROL PACKAGE (V45.0)                  #
#             EDITION: REFINED LOGIC (RECONCILE & EMERGENCY FIXES)             #
################################################################################


# ==============================================================================
# 1. KONFIGURATION (Input Helpers)
# ==============================================================================
input_boolean:
  zendure_auto_mode:
    name: "Zendure Automatik Aktiv"
    icon: mdi:robot
  
  zendure_emergency_charge:
    name: "Status: Not-Ladung läuft (System)"
    icon: mdi:battery-alert
  
  zendure_calib_mode_u1:
    name: "Status: Kalibrierung U1"
    icon: mdi:battery-sync
  zendure_calib_mode_u2:
    name: "Status: Kalibrierung U2"
    icon: mdi:battery-sync
  
  zendure_bypass_u1:
    name: "Intern: Bypass Latch U1"
    icon: mdi:lock-clock
  zendure_bypass_u2:
    name: "Intern: Bypass Latch U2"
    icon: mdi:lock-clock

input_datetime:
  zendure_last_full_charge_1:
    name: "Unit 1: Letzte 100%"
    has_date: true
    has_time: true
  zendure_last_full_charge_2:
    name: "Unit 2: Letzte 100%"
    has_date: true
    has_time: true

input_number:
  zendure_last_sent_1:
    name: "System: Letzter Wert Unit 1"
    min: -2
    max: 1200
    step: 1
    mode: box
  zendure_last_sent_2:
    name: "System: Letzter Wert Unit 2"
    min: -2
    max: 1200
    step: 1
    mode: box
  zendure_conf_max_output:
    name: "Zendure: Max. Einspeisung (Gesamt)"
    min: 0
    max: 800
    step: 10
    initial: 800
    unit_of_measurement: "W"
    mode: box
  zendure_conf_failsafe_watt:
    name: "Zendure: Failsafe Grundlast"
    min: 0
    max: 800
    step: 10
    initial: 130
    unit_of_measurement: "W"
  
  # Bias 10W (Standard)
  zendure_conf_grid_bias:
    name: "Zendure: Netz-Puffer (Bias)"
    min: -100
    max: 100
    step: 1
    initial: 10
    unit_of_measurement: "W"
  
  # Min Change Slider (Used as Base: 5W Sport / 20W Zen)
  zendure_conf_min_change:
    name: "Zendure: Min. Änderungsschritt"
    min: 1
    max: 50
    step: 1
    initial: 5
    unit_of_measurement: "W"
    
  # Hysteresis 10W (Standard)
  zendure_conf_hysteresis:
    name: "Zendure: Regel-Hysterese (Deadband)"
    min: 0
    max: 50
    step: 1
    initial: 10
    unit_of_measurement: "W"
    
  zendure_conf_soc_off:
    name: "SoC Limit: Not-Aus (Software)"
    min: 0
    max: 30
    step: 1
    initial: 20
    unit_of_measurement: "%"
  zendure_conf_soc_bypass:
    name: "SoC Limit: Schonmodus (Start)"
    min: 10
    max: 90
    step: 1
    initial: 25
    unit_of_measurement: "%"
  zendure_conf_soc_emerg_start:
    name: "SoC Limit: Start Not-Ladung"
    min: 0
    max: 50
    step: 1
    initial: 15
  zendure_conf_soc_emerg_stop:
    name: "SoC Limit: Stopp Not-Ladung"
    min: 0
    max: 90
    step: 1
    initial: 20
  zendure_conf_calib_days:
    name: "Kalibrierung: Intervall"
    min: 1
    max: 60
    step: 1
    initial: 14
    unit_of_measurement: "Tage"

# ==============================================================================
# 2. MQTT SENSOREN
# ==============================================================================
mqtt:
  sensor:
    # --- UNIT 1 ---
    - name: "SolarFlow 1 Solar Input Total"
      unique_id: solarflow_1_solar_input_mqtt
      default_entity_id: sensor.solarflow_1_solar_input
      state_topic: "Zendure/sensor/HUB1_SERIAL_NUMBER/solarInputPower"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "SolarFlow 1 Grid Input Power"
      unique_id: solarflow_1_grid_input_mqtt
      default_entity_id: sensor.solarflow_1_grid_input_power
      state_topic: "Zendure/sensor/HUB1_SERIAL_NUMBER/gridInputPower"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "SolarFlow 1 Battery Level Hub"
      unique_id: solarflow_1_battery_level_mqtt
      default_entity_id: sensor.solarflow_1_battery_level_hub
      state_topic: "Zendure/sensor/HUB1_SERIAL_NUMBER/electricLevel"
      unit_of_measurement: "%"
      device_class: battery
      state_class: measurement

    - name: "SolarFlow 1 Output Power"
      unique_id: solarflow_1_output_power_mqtt
      default_entity_id: sensor.solarflow_1_output_power
      state_topic: "Zendure/sensor/HUB1_SERIAL_NUMBER/outputHomePower"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "SolarFlow 1 Output Limit"
      unique_id: solarflow_1_output_limit_mqtt
      default_entity_id: sensor.solarflow_1_output_limit
      state_topic: "Zendure/number/HUB1_SERIAL_NUMBER/outputLimit"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      entity_category: diagnostic

    # Feedback Sensors
    - name: "SolarFlow 1 Setting MinSoC"
      unique_id: solarflow_1_setting_minsoc
      default_entity_id: sensor.solarflow_1_setting_minsoc
      state_topic: "Zendure/number/HUB1_SERIAL_NUMBER/minSoc"
      unit_of_measurement: "%"
    
    - name: "SolarFlow 1 Setting ChargeLimit"
      unique_id: solarflow_1_setting_chargelimit
      default_entity_id: sensor.solarflow_1_setting_chargelimit
      state_topic: "Zendure/number/HUB1_SERIAL_NUMBER/chargeMaxLimit"
      unit_of_measurement: "W"

    - name: "SolarFlow 1 Temp"
      unique_id: solarflow_1_temp_mqtt
      default_entity_id: sensor.solarflow_1_temp
      state_topic: "Zendure/sensor/HUB1_SERIAL_NUMBER/hyperTmp"
      unit_of_measurement: "°C"
      device_class: temperature # V45
      state_class: measurement
      value_template: >
        {% set v = value | float(0) %}
        {% if v > 1000 %} {{ ((v - 2731) / 10) | round(1) }}
        {% else %} {{ v }} {% endif %}

    - name: "SolarFlow 1 Battery Max Temp"
      unique_id: solarflow_1_batt_max_temp
      default_entity_id: sensor.solarflow_1_batt_max_temp
      state_topic: "Zendure/sensor/BAT1_SERIAL_NUMBER/maxTemp"
      unit_of_measurement: "°C"
      device_class: temperature # V45
      state_class: measurement
      value_template: >
        {% set v = value | float(0) %}
        {% if v > 1000 %} {{ ((v - 2731) / 10) | round(1) }}
        {% else %} {{ v }} {% endif %}

    - name: "SolarFlow 1 Cell Max Vol"
      unique_id: solarflow_1_cell_max_vol
      default_entity_id: sensor.solarflow_1_cell_max_vol
      state_topic: "Zendure/sensor/BAT1_SERIAL_NUMBER/maxVol"
      unit_of_measurement: "V"
      device_class: voltage # V45
      state_class: measurement
      value_template: >
        {% set v = value | float(none) %}
        {% if v is none %} {{ 'unavailable' }}
        {% elif v > 20 %} {{ (v / 100) | round(3) }}
        {% else %} {{ v | round(3) }}
        {% endif %}

    - name: "SolarFlow 1 Cell Min Vol"
      unique_id: solarflow_1_cell_min_vol
      default_entity_id: sensor.solarflow_1_cell_min_vol
      state_topic: "Zendure/sensor/BAT1_SERIAL_NUMBER/minVol"
      unit_of_measurement: "V"
      device_class: voltage # V45
      state_class: measurement
      value_template: >
        {% set v = value | float(none) %}
        {% if v is none %} {{ 'unavailable' }}
        {% elif v > 20 %} {{ (v / 100) | round(3) }}
        {% else %} {{ v | round(3) }}
        {% endif %}
      

    # --- UNIT 2 ---
    - name: "SolarFlow 2 Solar Input Total"
      unique_id: solarflow_2_solar_input_mqtt
      default_entity_id: sensor.solarflow_2_solar_input
      state_topic: "Zendure/sensor/HUB2_SERIAL_NUMBER/solarInputPower"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "SolarFlow 2 Grid Input Power"
      unique_id: solarflow_2_grid_input_mqtt
      default_entity_id: sensor.solarflow_2_grid_input_power
      state_topic: "Zendure/sensor/HUB2_SERIAL_NUMBER/gridInputPower"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "SolarFlow 2 Battery Level Hub"
      unique_id: solarflow_2_battery_level_mqtt
      default_entity_id: sensor.solarflow_2_battery_level_hub
      state_topic: "Zendure/sensor/HUB2_SERIAL_NUMBER/electricLevel"
      unit_of_measurement: "%"
      device_class: battery
      state_class: measurement

    - name: "SolarFlow 2 Output Power"
      unique_id: solarflow_2_output_power_mqtt
      default_entity_id: sensor.solarflow_2_output_power
      state_topic: "Zendure/sensor/HUB2_SERIAL_NUMBER/outputHomePower"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement

    - name: "SolarFlow 2 Output Limit"
      unique_id: solarflow_2_output_limit_mqtt
      default_entity_id: sensor.solarflow_2_output_limit
      state_topic: "Zendure/number/HUB2_SERIAL_NUMBER/outputLimit"
      unit_of_measurement: "W"
      device_class: power
      state_class: measurement
      entity_category: diagnostic

    # Feedback Sensors
    - name: "SolarFlow 2 Setting MinSoC"
      unique_id: solarflow_2_setting_minsoc
      default_entity_id: sensor.solarflow_2_setting_minsoc
      state_topic: "Zendure/number/HUB2_SERIAL_NUMBER/minSoc"
      unit_of_measurement: "%"
    
    - name: "SolarFlow 2 Setting ChargeLimit"
      unique_id: solarflow_2_setting_chargelimit
      default_entity_id: sensor.solarflow_2_setting_chargelimit
      state_topic: "Zendure/number/HUB2_SERIAL_NUMBER/chargeMaxLimit"
      unit_of_measurement: "W"

    - name: "SolarFlow 2 Temp"
      unique_id: solarflow_2_temp_mqtt
      default_entity_id: sensor.solarflow_2_temp
      state_topic: "Zendure/sensor/HUB2_SERIAL_NUMBER/hyperTmp"
      unit_of_measurement: "°C"
      device_class: temperature # V45
      state_class: measurement
      value_template: >
        {% set v = value | float(0) %}
        {% if v > 1000 %} {{ ((v - 2731) / 10) | round(1) }}
        {% else %} {{ v }} {% endif %}

    - name: "SolarFlow 2 Battery Max Temp"
      unique_id: solarflow_2_batt_max_temp
      default_entity_id: sensor.solarflow_2_batt_max_temp
      state_topic: "Zendure/sensor/BAT2_SERIAL_NUMBER/maxTemp"
      unit_of_measurement: "°C"
      device_class: temperature # V45
      state_class: measurement
      value_template: >
        {% set v = value | float(0) %}
        {% if v > 1000 %} {{ ((v - 2731) / 10) | round(1) }}
        {% else %} {{ v }} {% endif %}

    - name: "SolarFlow 2 Cell Max Vol"
      unique_id: solarflow_2_cell_max_vol
      default_entity_id: sensor.solarflow_2_cell_max_vol
      state_topic: "Zendure/sensor/BAT2_SERIAL_NUMBER/maxVol"
      unit_of_measurement: "V"
      device_class: voltage # V45
      state_class: measurement
      value_template: >
        {% set v = value | float(none) %}
        {% if v is none %} {{ 'unavailable' }}
        {% elif v > 20 %} {{ (v / 100) | round(3) }}
        {% else %} {{ v | round(3) }}
        {% endif %}

    - name: "SolarFlow 2 Cell Min Vol"
      unique_id: solarflow_2_cell_min_vol
      default_entity_id: sensor.solarflow_2_cell_min_vol
      state_topic: "Zendure/sensor/BAT2_SERIAL_NUMBER/minVol"
      unit_of_measurement: "V"
      device_class: voltage # V45
      state_class: measurement
      value_template: >
        {% set v = value | float(none) %}
        {% if v is none %} {{ 'unavailable' }}
        {% elif v > 20 %} {{ (v / 100) | round(3) }}
        {% else %} {{ v | round(3) }}
        {% endif %}

    # --- WATCHDOGS (120s Expiry) ---
    - name: "SolarFlow 1 Status Raw"
      unique_id: solarflow_1_status_mqtt
      default_entity_id: sensor.solarflow_1_status_raw
      state_topic: "Zendure/sensor/HUB1_SERIAL_NUMBER/packState"
      value_template: "{{ value }}"
      expire_after: 120

    - name: "SolarFlow 2 Status Raw"
      unique_id: solarflow_2_status_mqtt
      default_entity_id: sensor.solarflow_2_status_raw
      state_topic: "Zendure/sensor/HUB2_SERIAL_NUMBER/packState"
      value_template: "{{ value }}"
      expire_after: 120

# ==============================================================================
# 3. HELPER SENSOREN
# ==============================================================================
template:
  - sensor:
      - name: "SolarFlow 1 Battery Level"
        unique_id: solarflow_1_battery_level
        default_entity_id: sensor.solarflow_1_battery_level
        device_class: battery
        state_class: measurement
        unit_of_measurement: "%"
        availability: >
          {{ states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] 
             and is_number(states('sensor.solarflow_1_battery_level_hub')) }}
        state: >
          {{ states('sensor.solarflow_1_battery_level_hub') | int(0) }}
        
      - name: "SolarFlow 2 Battery Level"
        unique_id: solarflow_2_battery_level
        default_entity_id: sensor.solarflow_2_battery_level
        device_class: battery
        state_class: measurement
        unit_of_measurement: "%"
        availability: >
          {{ states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] 
             and is_number(states('sensor.solarflow_2_battery_level_hub')) }}
        state: >
          {{ states('sensor.solarflow_2_battery_level_hub') | int(0) }}

      - name: "SolarFlow Total Solar Input"
        unique_id: solarflow_total_solar_input
        default_entity_id: sensor.solarflow_total_solar_input
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set s1_ok = states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] %}
          {% set s2_ok = states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] %}
          {% set s1 = states('sensor.solarflow_1_solar_input')|float(0) if s1_ok else 0 %}
          {% set s2 = states('sensor.solarflow_2_solar_input')|float(0) if s2_ok else 0 %}
          {{ (s1 + s2) | int }}

      - name: "SolarFlow Total Grid Input"
        unique_id: solarflow_total_grid_input
        default_entity_id: sensor.solarflow_total_grid_input
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set s1_ok = states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] %}
          {% set s2_ok = states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] %}
          {% set s1 = states('sensor.solarflow_1_grid_input_power')|float(0) if s1_ok else 0 %}
          {% set s2 = states('sensor.solarflow_2_grid_input_power')|float(0) if s2_ok else 0 %}
          {{ (s1 + s2) | int }}

      - name: "SolarFlow System Total Output"
        unique_id: solarflow_system_total_output
        default_entity_id: sensor.solarflow_system_total_output
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set s1_ok = states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] %}
          {% set s2_ok = states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] %}
          {% set s1 = states('sensor.solarflow_1_output_power')|float(0) if s1_ok else 0 %}
          {% set s2 = states('sensor.solarflow_2_output_power')|float(0) if s2_ok else 0 %}
          {{ (s1 + s2) | int }}

      - name: "SolarFlow System Battery Level"
        unique_id: solarflow_system_battery_level
        default_entity_id: sensor.solarflow_system_battery_level
        unit_of_measurement: "%"
        device_class: battery
        state_class: measurement
        availability: >
          {% set s1 = states('sensor.solarflow_1_battery_level') | float(-1) %}
          {% set s2 = states('sensor.solarflow_2_battery_level') | float(-1) %}
          {{ s1 >= 0 or s2 >= 0 }}
        state: >
          {% set s1 = states('sensor.solarflow_1_battery_level') | float(-1) %}
          {% set s2 = states('sensor.solarflow_2_battery_level') | float(-1) %}
          {% set ns = namespace(sum=0, count=0) %}
          {% if s1 >= 0 %}{% set ns.sum = ns.sum + s1 %}{% set ns.count = ns.count + 1 %}{% endif %}
          {% if s2 >= 0 %}{% set ns.sum = ns.sum + s2 %}{% set ns.count = ns.count + 1 %}{% endif %}
          {{ (ns.sum / ns.count) | round(0) if ns.count > 0 else 0 }}

      - name: "SolarFlow 1 Cell Imbalance"
        unique_id: solarflow_1_cell_imbalance
        default_entity_id: sensor.solarflow_1_cell_imbalance
        unit_of_measurement: "V"
        state_class: measurement
        availability: >
          {{ states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] 
             and is_number(states('sensor.solarflow_1_cell_min_vol')) 
             and is_number(states('sensor.solarflow_1_cell_max_vol')) }}
        state: >
          {% set min_v = states('sensor.solarflow_1_cell_min_vol') | float(0) %}
          {% set max_v = states('sensor.solarflow_1_cell_max_vol') | float(0) %}
          {{ [ (max_v - min_v) | round(3), 0 ] | max }}

      - name: "SolarFlow 2 Cell Imbalance"
        unique_id: solarflow_2_cell_imbalance
        default_entity_id: sensor.solarflow_2_cell_imbalance
        unit_of_measurement: "V"
        state_class: measurement
        availability: >
          {{ states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] 
             and is_number(states('sensor.solarflow_2_cell_min_vol')) 
             and is_number(states('sensor.solarflow_2_cell_max_vol')) }}
        state: >
          {% set min_v = states('sensor.solarflow_2_cell_min_vol') | float(0) %}
          {% set max_v = states('sensor.solarflow_2_cell_max_vol') | float(0) %}
          {{ [ (max_v - min_v) | round(3), 0 ] | max }}

      - name: "SolarFlow System Total Charge Power V24"
        unique_id: solarflow_system_total_charge_power_v24
        default_entity_id: sensor.solarflow_system_total_charge_power_v24
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set solar = states('sensor.solarflow_total_solar_input') | float(0) %}
          {% set grid_in = states('sensor.solarflow_total_grid_input') | float(0) %}
          {% set output = states('sensor.solarflow_system_total_output') | float(0) %}
          {% set total_in = solar + grid_in %}
          {% set diff = total_in - output %}
          {{ diff if diff > 0 else 0 }}

      - name: "SolarFlow System Total Discharge Power V24"
        unique_id: solarflow_system_total_discharge_power_v24
        default_entity_id: sensor.solarflow_system_total_discharge_power_v24
        unit_of_measurement: "W"
        device_class: power
        state_class: measurement
        state: >
          {% set solar = states('sensor.solarflow_total_solar_input') | float(0) %}
          {% set grid_in = states('sensor.solarflow_total_grid_input') | float(0) %}
          {% set output = states('sensor.solarflow_system_total_output') | float(0) %}
          {% set total_in = solar + grid_in %}
          {% set diff = output - total_in %}
          {{ diff if diff > 0 else 0 }}

# ==============================================================================
# 4. ENERGY SENSORS
# ==============================================================================
sensor:
  - platform: integration
    source: sensor.solarflow_total_solar_input
    name: "SolarFlow System Solar Yield Total"
    unit_prefix: k
    method: left
    max_sub_interval:
      minutes: 1
    
  - platform: integration
    source: sensor.solarflow_system_total_charge_power_v24
    name: "SolarFlow System Battery In Total V24"
    unit_prefix: k
    method: left
    max_sub_interval:
      minutes: 1

  - platform: integration
    source: sensor.solarflow_system_total_discharge_power_v24
    name: "SolarFlow System Battery Out Total V24"
    unit_prefix: k
    method: left
    max_sub_interval:
      minutes: 1

# ==============================================================================
# 5. AUTOMATISIERUNGEN (V45.0 Refined Logic)
# ==============================================================================
automation:
  # --- 6.1 SYNC ON STARTUP ---
  - alias: "Zendure: Sync Memory on Start"
    id: "zendure_sync_on_start"
    triggers:
      - trigger: homeassistant
        event: start
    actions:
      - delay: "00:00:10" # 10s wait for MQTT readiness
      - if: 
          - condition: template
            # V45: Robustness Check - Only sync if Device is Online and not in Fault state
            value_template: >
              {{ is_number(states('sensor.solarflow_1_output_limit'))
                 and states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR']
                 and (states('input_number.zendure_last_sent_1')|int(0) >= 0) }}
        then:
          - action: input_number.set_value
            target: { entity_id: input_number.zendure_last_sent_1 }
            data: { value: "{{ states('sensor.solarflow_1_output_limit')|int(0) }}" }
      - if: 
          - condition: template
            value_template: >
              {{ is_number(states('sensor.solarflow_2_output_limit'))
                 and states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR']
                 and (states('input_number.zendure_last_sent_2')|int(0) >= 0) }}
        then:
          - action: input_number.set_value
            target: { entity_id: input_number.zendure_last_sent_2 }
            data: { value: "{{ states('sensor.solarflow_2_output_limit')|int(0) }}" }

  # --- 6.2 ANTI-DRIFT ---
  - alias: "Zendure: Anti-Drift Watchdog"
    id: "zendure_anti_drift_watchdog"
    mode: queued
    triggers:
      - trigger: template
        id: "drift_1"
        value_template: "{{ is_number(states('sensor.solarflow_1_output_limit')) and (states('sensor.solarflow_1_output_limit')|float(0) - states('input_number.zendure_last_sent_1')|float(0))|abs > 30 }}"
        for: "00:01:00"
      - trigger: template
        id: "drift_2"
        value_template: "{{ is_number(states('sensor.solarflow_2_output_limit')) and (states('sensor.solarflow_2_output_limit')|float(0) - states('input_number.zendure_last_sent_2')|float(0))|abs > 30 }}"
        for: "00:01:00"
    conditions:
      - condition: state
        entity_id: input_boolean.zendure_auto_mode
        state: "on"
      - condition: template
        value_template: >
          {% if trigger.id == 'drift_1' %}
            {{ states('input_number.zendure_last_sent_1')|float(0) >= 0 }}
          {% else %}
            {{ states('input_number.zendure_last_sent_2')|float(0) >= 0 }}
          {% endif %}
    actions:
      - choose:
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'drift_1' }}"
            sequence:
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_last_sent_1 }
                data: { value: "{{ states('sensor.solarflow_1_output_limit')|int }}" }
          - conditions:
              - condition: template
                value_template: "{{ trigger.id == 'drift_2' }}"
            sequence:
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_last_sent_2 }
                data: { value: "{{ states('sensor.solarflow_2_output_limit')|int }}" }

  # --- 6.2b SYNC MEMORY FROM MQTT ---
  - alias: "Zendure: Sync Memory from OutputLimit"
    id: "zendure_sync_memory_from_outputlimit"
    mode: queued
    triggers:
      - trigger: state
        entity_id:
          - sensor.solarflow_1_output_limit
          - sensor.solarflow_2_output_limit
    conditions:
      - condition: template
        value_template: >
          {{ is_number(trigger.to_state.state)
             and is_state('input_boolean.zendure_emergency_charge','off')
             and is_state('input_boolean.zendure_calib_mode_u1','off')
             and is_state('input_boolean.zendure_calib_mode_u2','off') }}
    actions:
      - choose:
          - conditions: 
              - condition: template
                value_template: >
                  {{ trigger.entity_id == 'sensor.solarflow_1_output_limit'
                     and (states('input_number.zendure_last_sent_1')|int(0) >= 0) }}
            sequence:
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_last_sent_1 }
                data: { value: "{{ trigger.to_state.state | int }}" }
          - conditions: 
              - condition: template
                value_template: >
                  {{ trigger.entity_id == 'sensor.solarflow_2_output_limit'
                     and (states('input_number.zendure_last_sent_2')|int(0) >= 0) }}
            sequence:
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_last_sent_2 }
                data: { value: "{{ trigger.to_state.state | int }}" }

  # --- 6.3 BYPASS LATCH MANAGER ---
  - alias: "Zendure: Bypass Latch Manager"
    id: "zendure_bypass_latch_manager"
    mode: single
    triggers:
      - trigger: state
        entity_id: [sensor.solarflow_1_battery_level, sensor.solarflow_2_battery_level]
      - trigger: homeassistant
        event: start
      - trigger: state
        entity_id: input_number.zendure_conf_soc_bypass
    actions:
      - variables:
          soc_entry: "{{ states('input_number.zendure_conf_soc_bypass') | int(30) }}"
          soc_exit: "{{ (soc_entry | int(30)) + 5 }}"
          soc1_ok: "{{ is_number(states('sensor.solarflow_1_battery_level')) }}"
          soc2_ok: "{{ is_number(states('sensor.solarflow_2_battery_level')) }}"
          soc1: "{{ states('sensor.solarflow_1_battery_level') | float(0) }}"
          soc2: "{{ states('sensor.solarflow_2_battery_level') | float(0) }}"
          
      - if: 
          - condition: template
            value_template: "{{ soc1_ok and soc1 <= soc_entry }}"
        then:
          - action: input_boolean.turn_on
            target: { entity_id: input_boolean.zendure_bypass_u1 }
      - if: 
          - condition: template
            value_template: "{{ soc1_ok and soc1 >= soc_exit }}"
        then:
          - action: input_boolean.turn_off
            target: { entity_id: input_boolean.zendure_bypass_u1 }
            
      - if: 
          - condition: template
            value_template: "{{ soc2_ok and soc2 <= soc_entry }}"
        then:
          - action: input_boolean.turn_on
            target: { entity_id: input_boolean.zendure_bypass_u2 }
      - if: 
          - condition: template
            value_template: "{{ soc2_ok and soc2 >= soc_exit }}"
        then:
          - action: input_boolean.turn_off
            target: { entity_id: input_boolean.zendure_bypass_u2 }

  # --- 6.4 CONTROL LOOP (STABLE CORE) ---
  - alias: "Zendure: Control Loop (Dual)"
    id: "zendure_control_loop_dual"
    mode: single
    max_exceeded: silent
    triggers:
      - trigger: time_pattern
        seconds: "/5"
      - trigger: numeric_state
        entity_id: sensor.shellypro3em_SHELLY_ID_total_active_power
        above: 150
        for: "00:00:01"
      - trigger: numeric_state
        entity_id: sensor.shellypro3em_SHELLY_ID_total_active_power
        below: -30
        for: "00:00:01"
      - trigger: state
        entity_id: 
          - input_boolean.zendure_bypass_u1
          - input_boolean.zendure_bypass_u2
    conditions:
      - condition: state
        entity_id: input_boolean.zendure_auto_mode
        state: "on"
    actions:
      - variables:
          s1_ok: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
          s2_ok: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
          s1_base: "{{ [states('input_number.zendure_last_sent_1')|float(0)|int, 0]|max }}"
          s2_base: "{{ [states('input_number.zendure_last_sent_2')|float(0)|int, 0]|max }}"
          soc_off: "{{ states('input_number.zendure_conf_soc_off') | int(10) }}"
          hysteresis: "{{ states('input_number.zendure_conf_hysteresis') | int(10) }}"
          soc1_val: "{{ states('sensor.solarflow_1_battery_level') | float(0) }}"
          soc2_val: "{{ states('sensor.solarflow_2_battery_level') | float(0) }}"
          t1: "{{ states('sensor.solarflow_1_batt_max_temp') | float(states('sensor.solarflow_1_temp')|float(99)) }}"
          t2: "{{ states('sensor.solarflow_2_batt_max_temp') | float(states('sensor.solarflow_2_temp')|float(99)) }}"
          bypass1: "{{ is_state('input_boolean.zendure_bypass_u1','on') }}"
          bypass2: "{{ is_state('input_boolean.zendure_bypass_u2','on') }}"
          s1_solar: "{{ states('sensor.solarflow_1_solar_input') | float(0) if s1_ok else 0 }}"
          s2_solar: "{{ states('sensor.solarflow_2_solar_input') | float(0) if s2_ok else 0 }}"
          calib1: "{{ is_state('input_boolean.zendure_calib_mode_u1', 'on') }}"
          calib2: "{{ is_state('input_boolean.zendure_calib_mode_u2', 'on') }}"
          emerg_global: "{{ is_state('input_boolean.zendure_emergency_charge', 'on') }}"
          emerg_stop: "{{ states('input_number.zendure_conf_soc_emerg_stop') | int(20) }}"
          
          # Sentinel Check
          sentinel_u1: "{{ states('input_number.zendure_last_sent_1')|int(0) == -2 }}"
          sentinel_u2: "{{ states('input_number.zendure_last_sent_2')|int(0) == -2 }}"
          busy_u1: "{{ calib1 or sentinel_u1 or (emerg_global and soc1_val < emerg_stop) }}"
          busy_u2: "{{ calib2 or sentinel_u2 or (emerg_global and soc2_val < emerg_stop) }}"

          # Ghost Load
          ghost_load_1: "{{ s1_base if (not s1_ok and s1_base > 0) else 0 }}"
          ghost_load_2: "{{ s2_base if (not s2_ok and s2_base > 0) else 0 }}"
          ghost_total: "{{ ghost_load_1 + ghost_load_2 }}"

          cap_u1: >
            {% if not s1_ok or busy_u1 %}0
            {% elif t1 < 0 or t1 > 45 or soc1_val <= soc_off or bypass1 %}{{ (s1_solar * 0.9) | int(0) }}
            {% else %}800{% endif %}
          cap_u2: >
            {% if not s2_ok or busy_u2 %}0
            {% elif t2 < 0 or t2 > 45 or soc2_val <= soc_off or bypass2 %}{{ (s2_solar * 0.9) | int(0) }}
            {% else %}800{% endif %}
          
          override_u1: "{{ s1_ok and (s1_base|int(0) > cap_u1|int(0)) }}"
          override_u2: "{{ s2_ok and (s2_base|int(0) > cap_u2|int(0)) }}"
          safety_override: "{{ override_u1 or override_u2 }}"

          global_max: "{{ states('input_number.zendure_conf_max_output') | int(800) }}"
          available_capacity: "{{ [ (global_max - ghost_total), 0 ] | max }}"

          failsafe: "{{ states('input_number.zendure_conf_failsafe_watt') | int(130) }}"
          grid_bias: "{{ states('input_number.zendure_conf_grid_bias') | int(10) }}"
          
          zen_mode: "{{ (bypass1 or bypass2) }}"
          slider_change: "{{ states('input_number.zendure_conf_min_change') | int(5) }}"
          min_change: "{{ (slider_change * 4) if zen_mode else slider_change }}"

          shelly_ok: "{{ is_number(states('sensor.shellypro3em_SHELLY_ID_total_active_power')) }}"
          grid: "{{ (states('sensor.shellypro3em_SHELLY_ID_total_active_power') | float(0)) if shelly_ok else 0 }}"
          total_base: "{{ (s1_base | int(0)) + (s2_base | int(0)) }}"
          
          target_raw: >-
            {{ ((total_base | int(0)) + (grid | float(0)) - (grid_bias | int(0)))
                if shelly_ok else (failsafe | int(0)) }}
          delta: "{{ (target_raw | float(0)) - (total_base | float(0)) }}"
          
          target_total: "{{ [[target_raw|int(0), 0]|max, global_max]|min }}"
          delta_effective: "{{ (target_total|int(0)) - (total_base|int(0)) }}"
      
      # Safety Gate
      - condition: template
        value_template: >
          {{ safety_override 
             or ((delta_effective | abs) > (hysteresis | int(0)))
             or (total_base | int(0) > global_max | int(0)) }}

      - variables:
          target_online: "{{ [[(target_total - ghost_total)|int(0), 0]|max, available_capacity]|min }}"
          
          soc1_valid: "{{ is_number(states('sensor.solarflow_1_battery_level')) }}"
          soc2_valid: "{{ is_number(states('sensor.solarflow_2_battery_level')) }}"
          active_1: "{{ s1_ok }}"
          active_2: "{{ s2_ok }}"
          weight_1: >-
            {% if soc1_valid and soc2_valid and (soc1_val + soc2_val) > 0 %}
              {{ soc1_val / (soc1_val + soc2_val) }}
            {% else %}
              0.5
            {% endif %}
          req_1: "{{ ((target_online | int(0)) * (weight_1 | float(0))) | int(0) }}"
          req_2: "{{ (target_online | int(0)) - (req_1 | int(0)) }}"
          
          floor_1: >-
            {% if soc1_val >= 98 and not busy_u1 %}
              {% if s1_solar > 400 %} 350
              {% elif s1_solar > 300 %} 250
              {% else %} 0 {% endif %}
            {% else %} 0 {% endif %}
          floor_2: >-
            {% if soc2_val >= 98 and not busy_u2 %}
              {% if s2_solar > 400 %} 350
              {% elif s2_solar > 300 %} 250
              {% else %} 0 {% endif %}
            {% else %} 0 {% endif %}
          
          req_1_final: "{{ [req_1|int(0), floor_1|int(0)]|max }}"
          req_2_final: "{{ [req_2|int(0), floor_2|int(0)]|max }}"
          final_1_init: "{{ [req_1_final|int(0), cap_u1|int(0)]|min }}"
          
          final_2_raw: >
            {% if active_2 %}
              {% set v = (req_2_final + (req_1_final - final_1_init)) | int(0) %}
              {{ [[v, 0] | max, cap_u2 | int(0)] | min }}
            {% else %}
              0
            {% endif %}
          
          final_1_raw: >
            {% if active_1 %}
              {% set v = (target_online | int(0)) - (final_2_raw | int(0)) %}
              {% set v_safe = [v, floor_1]|max %}
              {{ [[v_safe, 0] | max, cap_u1 | int(0)] | min }}
            {% else %}
              0
            {% endif %}
          
          active_sum: >-
            {% set a1 = final_1_raw|int(0) if active_1 else 0 %}
            {% set a2 = final_2_raw|int(0) if active_2 else 0 %}
            {{ a1 + a2 }}
          
          scale_active: >-
            {% set cap = available_capacity|int(0) %}
            {% set s = active_sum|int(0) %}
            {% if s <= 0 %} 1
            {% elif cap <= 0 %} 0
            {% elif s > cap %} {{ cap / s }}
            {% else %} 1
            {% endif %}

          final_1: "{{ (final_1_raw|int(0) * scale_active) | int }}"
          final_2: "{{ (final_2_raw|int(0) * scale_active) | int }}"

      - parallel:
          # V43: Override U1
          - if: 
              - condition: template
                value_template: >-
                  {{ s1_ok and not busy_u1 and (
                       ((final_1|int(0) - s1_base|int(0))|abs >= (min_change|int(0)))
                       or override_u1
                       or ((total_base|int(0) > global_max|int(0)) and (s1_base|int(0) > final_1|int(0)))
                     ) }}
            then:
              - action: mqtt.publish
                data:
                  topic: "Zendure/number/HUB1_SERIAL_NUMBER/outputLimit/set"
                  payload: "{{ final_1|int }}"
                  qos: 1
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_last_sent_1 }
                data: { value: "{{ final_1|int }}" }

          # V44: Logic structure matched to U1 (parentheses consistency)
          - if: 
              - condition: template
                value_template: >-
                  {{ s2_ok and not busy_u2 and (
                       ((final_2|int(0) - s2_base|int(0))|abs >= (min_change|int(0)))
                       or override_u2
                       or ((total_base|int(0) > global_max|int(0)) and (s2_base|int(0) > final_2|int(0)))
                     ) }}
            then:
              - action: mqtt.publish
                data:
                  topic: "Zendure/number/HUB2_SERIAL_NUMBER/outputLimit/set"
                  payload: "{{ final_2|int }}"
                  qos: 1
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_last_sent_2 }
                data: { value: "{{ final_2|int }}" }

  # --- 6.5 STATE MACHINE (REFINED LOGIC) ---
  - alias: "Zendure: State Machine (Smart Single-Channel)"
    id: "zendure_state_machine_dual"
    mode: queued
    triggers:
      - trigger: state
        entity_id: 
          - input_boolean.zendure_emergency_charge
          - input_boolean.zendure_calib_mode_u1
          - input_boolean.zendure_calib_mode_u2
        to: "on"
      - trigger: state
        entity_id: 
          - input_boolean.zendure_emergency_charge
          - input_boolean.zendure_calib_mode_u1
          - input_boolean.zendure_calib_mode_u2
        to: "off"
      - trigger: state
        entity_id: input_boolean.zendure_auto_mode
        to: "on"
      - trigger: state
        entity_id: input_boolean.zendure_auto_mode
        to: "off"
        id: "auto_off"
      
      # V45: Reconcile Trigger (Update Limits every 5min based on Temp/SoC)
      - trigger: time_pattern
        minutes: "/5"
        id: "periodic_reconcile"
      
      - trigger: state
        entity_id: [sensor.solarflow_1_battery_level, sensor.solarflow_2_battery_level]
        for: "00:05:00"
      
      # V44: Trigger Damping (5s stable state required)
      - trigger: template
        id: "device_online_u1"
        value_template: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable','unknown','FAULT','ERROR'] }}"
        for: "00:00:05"
      - trigger: template
        id: "device_online_u2"
        value_template: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable','unknown','FAULT','ERROR'] }}"
        for: "00:00:05"
      
      - trigger: homeassistant
        event: start
        id: "boot_check"
    actions:
      - choose:
          # AUTO-OFF FULL RESET (Flags off, Mode Output, Limit 0)
          - conditions: "{{ trigger.id == 'auto_off' }}"
            sequence:
              - action: input_boolean.turn_off
                target:
                  entity_id:
                    - input_boolean.zendure_emergency_charge
                    - input_boolean.zendure_calib_mode_u1
                    - input_boolean.zendure_calib_mode_u2
              
              - parallel:
                # UNIT 1 Reset
                - if:
                    - condition: template
                      value_template: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable','unknown','FAULT','ERROR'] }}"
                  then:
                    - action: mqtt.publish
                      data: { topic: "Zendure/select/HUB1_SERIAL_NUMBER/acMode/set", payload: "Output mode", qos: 1 }
                    - action: mqtt.publish
                      data: { topic: "Zendure/number/HUB1_SERIAL_NUMBER/outputLimit/set", payload: "0", qos: 1 }
                    - action: input_number.set_value
                      target: { entity_id: input_number.zendure_last_sent_1 }
                      data: { value: 0 }
                
                # UNIT 2 Reset
                - if:
                    - condition: template
                      value_template: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable','unknown','FAULT','ERROR'] }}"
                  then:
                    - action: mqtt.publish
                      data: { topic: "Zendure/select/HUB2_SERIAL_NUMBER/acMode/set", payload: "Output mode", qos: 1 }
                    - action: mqtt.publish
                      data: { topic: "Zendure/number/HUB2_SERIAL_NUMBER/outputLimit/set", payload: "0", qos: 1 }
                    - action: input_number.set_value
                      target: { entity_id: input_number.zendure_last_sent_2 }
                      data: { value: 0 }
              - stop: "Automatik beendet - Full Hard Reset."
          
          # DEVICE ONLINE & BOOT CHECK (SmartMode & Safety Reconnect)
          - conditions: "{{ trigger.id in ['device_online_u1', 'device_online_u2', 'boot_check'] }}"
            sequence:
              - delay: "00:00:05"
              
              # A) SmartMode Double Tap
              - parallel:
                - if: 
                    - condition: template
                      value_template: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
                  then:
                    - action: mqtt.publish
                      data: { topic: "Zendure/switch/HUB1_SERIAL_NUMBER/smartMode/set", payload: "ON", qos: 1 }
                - if: 
                    - condition: template
                      value_template: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
                  then:
                    - action: mqtt.publish
                      data: { topic: "Zendure/switch/HUB2_SERIAL_NUMBER/smartMode/set", payload: "ON", qos: 1 }
              - delay: "00:00:02"
              - parallel:
                - if: 
                    - condition: template
                      value_template: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
                  then:
                    - action: mqtt.publish
                      data: { topic: "Zendure/switch/HUB1_SERIAL_NUMBER/smartMode/set", payload: "ON", qos: 1 }
                - if: 
                    - condition: template
                      value_template: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
                  then:
                    - action: mqtt.publish
                      data: { topic: "Zendure/switch/HUB2_SERIAL_NUMBER/smartMode/set", payload: "ON", qos: 1 }

              # B) SAFETY RECONNECT: If Auto-Mode is OFF, force 0W + Output Mode + Reset Memory
              - if:
                  - condition: template
                    value_template: "{{ is_state('input_boolean.zendure_auto_mode','off') }}"
                then:
                  - parallel:
                      - if:
                          - condition: template
                            value_template: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable','unknown','FAULT','ERROR'] }}"
                        then:
                          - action: mqtt.publish
                            data: { topic: "Zendure/select/HUB1_SERIAL_NUMBER/acMode/set", payload: "Output mode", qos: 1 }
                          - action: mqtt.publish
                            data: { topic: "Zendure/number/HUB1_SERIAL_NUMBER/outputLimit/set", payload: "0", qos: 1 }
                          - action: input_number.set_value
                            target: { entity_id: input_number.zendure_last_sent_1 }
                            data: { value: 0 }
                            
                      - if:
                          - condition: template
                            value_template: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable','unknown','FAULT','ERROR'] }}"
                        then:
                          - action: mqtt.publish
                            data: { topic: "Zendure/select/HUB2_SERIAL_NUMBER/acMode/set", payload: "Output mode", qos: 1 }
                          - action: mqtt.publish
                            data: { topic: "Zendure/number/HUB2_SERIAL_NUMBER/outputLimit/set", payload: "0", qos: 1 }
                          - action: input_number.set_value
                            target: { entity_id: input_number.zendure_last_sent_2 }
                            data: { value: 0 }
                  - stop: "Auto-Mode OFF: Safety Reconnect Hard-Stop applied."

      - variables:
          online1: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
          online2: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
          min_soc: 5
          t1: "{{ states('sensor.solarflow_1_batt_max_temp') | float(states('sensor.solarflow_1_temp')|float(99)) }}"
          t2: "{{ states('sensor.solarflow_2_batt_max_temp') | float(states('sensor.solarflow_2_temp')|float(99)) }}"
          soc1: "{{ states('sensor.solarflow_1_battery_level') | float(0) }}"
          soc2: "{{ states('sensor.solarflow_2_battery_level') | float(0) }}"
          cl1: "{% if t1 < 5 %} 100 {% elif t1 < 10 %} 300 {% else %} 800 {% endif %}"
          cl2: "{% if t2 < 5 %} 100 {% elif t2 < 10 %} 300 {% else %} 800 {% endif %}"
          sl1: "{% if soc1 > 97 %} 100 {% elif soc1 >= 90 %} 200 {% else %} 800 {% endif %}"
          sl2: "{% if soc2 > 97 %} 100 {% elif soc2 >= 90 %} 200 {% else %} 800 {% endif %}"
          ss1: "{% if soc1 < 12 %} 300 {% else %} 800 {% endif %}"
          ss2: "{% if soc2 < 12 %} 300 {% else %} 800 {% endif %}"
          charge_limit_u1: "{{ [cl1|int, sl1|int, ss1|int]|min }}"
          limit_emerg_u1: "{{ [300, cl1|int, ss1|int]|min }}"
          limit_calib_u1: "{{ [cl1|int, sl1|int]|min }}"
          charge_limit_u2: "{{ [cl2|int, sl2|int, ss2|int]|min }}"
          limit_emerg_u2: "{{ [300, cl2|int, ss2|int]|min }}"
          limit_calib_u2: "{{ [cl2|int, sl2|int]|min }}"
          curr_min_soc_1: "{{ states('sensor.solarflow_1_setting_minsoc') | int(-1) }}"
          curr_charge_1: "{{ states('sensor.solarflow_1_setting_chargelimit') | int(-1) }}"
          curr_min_soc_2: "{{ states('sensor.solarflow_2_setting_minsoc') | int(-1) }}"
          curr_charge_2: "{{ states('sensor.solarflow_2_setting_chargelimit') | int(-1) }}"
          emerg_global: "{{ is_state('input_boolean.zendure_emergency_charge', 'on') }}"
          emerg_stop: "{{ states('input_number.zendure_conf_soc_emerg_stop') | int(20) }}"

      - if: 
          - condition: template
            value_template: "{{ is_state('input_boolean.zendure_auto_mode','on') }}"
        then:
          - parallel:
            - if: 
                - condition: template
                  value_template: "{{ online1 and (curr_min_soc_1 != min_soc|int or curr_charge_1 != charge_limit_u1|int) }}"
              then:
                - action: mqtt.publish
                  data: { topic: "Zendure/number/HUB1_SERIAL_NUMBER/minSoc/set", payload: "{{ min_soc }}", qos: 1 }
                - action: mqtt.publish
                  data: { topic: "Zendure/number/HUB1_SERIAL_NUMBER/chargeMaxLimit/set", payload: "{{ charge_limit_u1 }}", qos: 1 }
            - if: 
                - condition: template
                  value_template: "{{ online2 and (curr_min_soc_2 != min_soc|int or curr_charge_2 != charge_limit_u2|int) }}"
              then:
                - action: mqtt.publish
                  data: { topic: "Zendure/number/HUB2_SERIAL_NUMBER/minSoc/set", payload: "{{ min_soc }}", qos: 1 }
                - action: mqtt.publish
                  data: { topic: "Zendure/number/HUB2_SERIAL_NUMBER/chargeMaxLimit/set", payload: "{{ charge_limit_u2 }}", qos: 1 }
      
      - parallel:
          # --- UNIT 1 LOGIC (V39 Protocol) ---
          - sequence:
              - if: 
                  - condition: template
                    value_template: "{{ is_state('input_boolean.zendure_calib_mode_u1','on') and online1 }}"
                then:
                  # Force Charge (Input mode)
                  - action: mqtt.publish
                    data: { topic: "Zendure/select/HUB1_SERIAL_NUMBER/acMode/set", payload: "Input mode", qos: 1 }
                  # Force Output 0
                  - action: mqtt.publish
                    data: { topic: "Zendure/number/HUB1_SERIAL_NUMBER/outputLimit/set", payload: "0", qos: 1 }
                  - action: mqtt.publish
                    data: { topic: "Zendure/number/HUB1_SERIAL_NUMBER/inputLimit/set", payload: "{{ limit_calib_u1 }}", qos: 1 }
                  - action: input_number.set_value
                    target: { entity_id: input_number.zendure_last_sent_1 }
                    data: { value: -2 }
              
              - if: 
                  - condition: template
                    value_template: "{{ emerg_global and is_state('input_boolean.zendure_calib_mode_u1','off') and online1 and soc1 < emerg_stop }}"
                then:
                  - action: mqtt.publish
                    data: { topic: "Zendure/select/HUB1_SERIAL_NUMBER/acMode/set", payload: "Input mode", qos: 1 }
                  # Force Output 0
                  - action: mqtt.publish
                    data: { topic: "Zendure/number/HUB1_SERIAL_NUMBER/outputLimit/set", payload: "0", qos: 1 }
                  - action: mqtt.publish
                    data: { topic: "Zendure/number/HUB1_SERIAL_NUMBER/inputLimit/set", payload: "{{ limit_emerg_u1 }}", qos: 1 }
                  - action: input_number.set_value
                    target: { entity_id: input_number.zendure_last_sent_1 }
                    data: { value: -2 }

              # Return to Normal Mode
              - if: 
                  - condition: template
                    value_template: >
                      {{ (is_state('input_boolean.zendure_calib_mode_u1','off') 
                          and (not emerg_global or soc1 >= emerg_stop)
                          and online1
                          and states('input_number.zendure_last_sent_1')|int(0) == -2 ) }}
                then:
                   - action: mqtt.publish
                     data: { topic: "Zendure/select/HUB1_SERIAL_NUMBER/acMode/set", payload: "Output mode", qos: 1 }
                   - action: input_number.set_value
                     target: { entity_id: input_number.zendure_last_sent_1 }
                     data: { value: 0 }
                   - delay: "00:00:01" 

          # --- UNIT 2 LOGIC (V39 Protocol) ---
          - sequence:
              - if: 
                  - condition: template
                    value_template: "{{ is_state('input_boolean.zendure_calib_mode_u2','on') and online2 }}"
                then:
                  - action: mqtt.publish
                    data: { topic: "Zendure/select/HUB2_SERIAL_NUMBER/acMode/set", payload: "Input mode", qos: 1 }
                  - action: mqtt.publish
                    data: { topic: "Zendure/number/HUB2_SERIAL_NUMBER/outputLimit/set", payload: "0", qos: 1 }
                  - action: mqtt.publish
                    data: { topic: "Zendure/number/HUB2_SERIAL_NUMBER/inputLimit/set", payload: "{{ limit_calib_u2 }}", qos: 1 }
                  - action: input_number.set_value
                    target: { entity_id: input_number.zendure_last_sent_2 }
                    data: { value: -2 }
              
              - if: 
                  - condition: template
                    value_template: "{{ emerg_global and is_state('input_boolean.zendure_calib_mode_u2','off') and online2 and soc2 < emerg_stop }}"
                then:
                  - action: mqtt.publish
                    data: { topic: "Zendure/select/HUB2_SERIAL_NUMBER/acMode/set", payload: "Input mode", qos: 1 }
                  - action: mqtt.publish
                    data: { topic: "Zendure/number/HUB2_SERIAL_NUMBER/outputLimit/set", payload: "0", qos: 1 }
                  - action: mqtt.publish
                    data: { topic: "Zendure/number/HUB2_SERIAL_NUMBER/inputLimit/set", payload: "{{ limit_emerg_u2 }}", qos: 1 }
                  - action: input_number.set_value
                    target: { entity_id: input_number.zendure_last_sent_2 }
                    data: { value: -2 }

              # Return to Normal Mode
              - if: 
                  - condition: template
                    value_template: >
                      {{ (is_state('input_boolean.zendure_calib_mode_u2','off') 
                          and (not emerg_global or soc2 >= emerg_stop)
                          and online2
                          and states('input_number.zendure_last_sent_2')|int(0) == -2 ) }}
                then:
                   - action: mqtt.publish
                     data: { topic: "Zendure/select/HUB2_SERIAL_NUMBER/acMode/set", payload: "Output mode", qos: 1 }
                   - action: input_number.set_value
                     target: { entity_id: input_number.zendure_last_sent_2 }
                     data: { value: 0 }
                   - delay: "00:00:01"

  # --- 6.6 CALIBRATION MANAGER (V36: Daytime Sag & Natural Full Charge) ---
  - alias: "Zendure: Smart Calibration Manager"
    id: "zendure_calibration_manager"
    mode: queued
    triggers:
      - trigger: time
        at: "13:00:00"
        id: "check_time"
      - trigger: template
        id: "sag_u1"
        value_template: "{{ states('sensor.solarflow_1_cell_min_vol')|float(3.3) < 3.0 and states('sensor.solarflow_1_battery_level')|float(0) > 15 }}"
        for: "00:00:30"
      - trigger: template
        id: "sag_u2"
        value_template: "{{ states('sensor.solarflow_2_cell_min_vol')|float(3.3) < 3.0 and states('sensor.solarflow_2_battery_level')|float(0) > 15 }}"
        for: "00:00:30"
      - trigger: numeric_state
        entity_id: sensor.solarflow_1_battery_level
        above: 99
        for: "00:05:00"
        id: "stop_u1"
      - trigger: numeric_state
        entity_id: sensor.solarflow_2_battery_level
        above: 99
        for: "00:05:00"
        id: "stop_u2"
      - trigger: numeric_state
        entity_id: sensor.solarflow_1_battery_level
        above: 99
        id: "natural_full_u1"
      - trigger: numeric_state
        entity_id: sensor.solarflow_2_battery_level
        above: 99
        id: "natural_full_u2"
    conditions:
      - condition: state
        entity_id: input_boolean.zendure_auto_mode
        state: "on"
    actions:
      - variables:
          last_u1: "{{ as_timestamp(states('input_datetime.zendure_last_full_charge_1'), default=0) }}"
          last_u2: "{{ as_timestamp(states('input_datetime.zendure_last_full_charge_2'), default=0) }}"
          days_cfg: "{{ states('input_number.zendure_conf_calib_days') | int(14) }}"
          days_u1: "{{ ((as_timestamp(now()) - last_u1) / 86400) | int(0) }}"
          days_u2: "{{ ((as_timestamp(now()) - last_u2) / 86400) | int(0) }}"
      
      - if: 
          - condition: template
            value_template: "{{ trigger.id == 'stop_u1' or trigger.id == 'natural_full_u1' }}"
        then:
          - action: input_datetime.set_datetime
            target: { entity_id: input_datetime.zendure_last_full_charge_1 }
            data: { timestamp: "{{ as_timestamp(now()) }}" }
      
      - if: 
          - condition: template
            value_template: "{{ trigger.id == 'stop_u2' or trigger.id == 'natural_full_u2' }}"
        then:
          - action: input_datetime.set_datetime
            target: { entity_id: input_datetime.zendure_last_full_charge_2 }
            data: { timestamp: "{{ as_timestamp(now()) }}" }

      - if: 
          - condition: template
            value_template: "{{ trigger.id == 'check_time' and days_u1 > days_cfg and is_state('input_boolean.zendure_calib_mode_u1', 'off') }}"
        then:
          - action: input_boolean.turn_on
            target: { entity_id: input_boolean.zendure_calib_mode_u1 }
          - action: notify.send_message
            target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
            data: { message: "📅 *Kalibrierung U1*\nGestartet (Zeit-Trigger: {{ days_u1 }} Tage)." }
      
      # V36: Sag Trigger restricted to daytime (10-15h)
      - if: 
          - condition: template
            value_template: "{{ trigger.id == 'sag_u1' and is_state('input_boolean.zendure_calib_mode_u1', 'off') and 10 <= now().hour < 15 }}"
        then:
          - action: input_boolean.turn_on
            target: { entity_id: input_boolean.zendure_calib_mode_u1 }
          - action: notify.send_message
            target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
            data: { message: "📉 *Not-Kalibrierung U1*\nSpannungseinbruch erkannt (Voltage Sag)!" }

      - if: 
          - condition: template
            value_template: "{{ trigger.id == 'check_time' and days_u2 > days_cfg and is_state('input_boolean.zendure_calib_mode_u2', 'off') }}"
        then:
          - action: input_boolean.turn_on
            target: { entity_id: input_boolean.zendure_calib_mode_u2 }
          - action: notify.send_message
            target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
            data: { message: "📅 *Kalibrierung U2*\nGestartet (Zeit-Trigger: {{ days_u2 }} Tage)." }
      
      # V36: Sag Trigger restricted to daytime (10-15h)
      - if: 
          - condition: template
            value_template: "{{ trigger.id == 'sag_u2' and is_state('input_boolean.zendure_calib_mode_u2', 'off') and 10 <= now().hour < 15 }}"
        then:
          - action: input_boolean.turn_on
            target: { entity_id: input_boolean.zendure_calib_mode_u2 }
          - action: notify.send_message
            target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
            data: { message: "📉 *Not-Kalibrierung U2*\nSpannungseinbruch erkannt (Voltage Sag)!" }

      - if: 
          - condition: template
            value_template: "{{ trigger.id == 'stop_u1' and is_state('input_boolean.zendure_calib_mode_u1','on') }}"
        then:
          - action: input_boolean.turn_off
            target: { entity_id: input_boolean.zendure_calib_mode_u1 }
          - action: notify.send_message
            target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
            data: { message: "✅ *Kalibrierung U1*\nErfolgreich beendet (100%)." }

      - if: 
          - condition: template
            value_template: "{{ trigger.id == 'stop_u2' and is_state('input_boolean.zendure_calib_mode_u2','on') }}"
        then:
          - action: input_boolean.turn_off
            target: { entity_id: input_boolean.zendure_calib_mode_u2 }
          - action: notify.send_message
            target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
            data: { message: "✅ *Kalibrierung U2*\nErfolgreich beendet (100%)." }

  # --- 6.7 HEALTH REPORTER ---
  - alias: "Zendure: Weekly Health Report"
    id: "zendure_weekly_report"
    triggers:
      - trigger: time
        at: "18:00:00"
    conditions:
      - condition: time
        weekday: [fri]
    actions:
      - variables:
          last_u1: "{{ as_timestamp(states('input_datetime.zendure_last_full_charge_1'), default=0) }}"
          last_u2: "{{ as_timestamp(states('input_datetime.zendure_last_full_charge_2'), default=0) }}"
          days_u1: "{{ ((as_timestamp(now()) - last_u1) / 86400) | int(0) }}"
          days_u2: "{{ ((as_timestamp(now()) - last_u2) / 86400) | int(0) }}"
          imb1_raw: "{{ states('sensor.solarflow_1_cell_imbalance') }}"
          imb2_raw: "{{ states('sensor.solarflow_2_cell_imbalance') }}"
      - action: notify.send_message
        target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
        data:
          message: >
            ℹ️ *Zendure Wochenbericht*
            Unit 1: {{ days_u1 }} Tage ({{ imb1_raw }} V)
            Unit 2: {{ days_u2 }} Tage ({{ imb2_raw }} V)

  # --- 6.8b AUTO-EMERGENCY MANAGER (V45: Periodic trigger no longer stops on Solar) ---
  - alias: "Zendure: Auto-Emergency Manager"
    id: "zendure_auto_emergency_manager"
    triggers:
      - trigger: time_pattern
        minutes: "/30"
        id: "periodic"
      
      - trigger: numeric_state
        id: "solar_stable_stop"
        entity_id: sensor.solarflow_total_solar_input
        above: 200
        for: "00:05:00"
      
      # V42: New dedicated Stop Trigger (Battery Full)
      - trigger: template
        id: "stop_min_soc"
        value_template: >
          {% set stop = states('input_number.zendure_conf_soc_emerg_stop')|float(20) %}
          {% set s1 = states('sensor.solarflow_1_battery_level')|float(-1) %}
          {% set s2 = states('sensor.solarflow_2_battery_level')|float(-1) %}
          {% set vals = [] %}
          {% if s1 >= 0 %}{% set vals = vals + [s1] %}{% endif %}
          {% if s2 >= 0 %}{% set vals = vals + [s2] %}{% endif %}
          {{ vals|length > 0 and (vals|min) >= stop }}
        for: "00:02:00"
      
      # V36: Start Condition (Low Solar + Low Battery for 10 min)
      - trigger: template
        id: "stable_start_u1"
        value_template: >
          {{ is_number(states('sensor.solarflow_1_battery_level')) 
             and states('sensor.solarflow_1_battery_level')|float(0) < states('input_number.zendure_conf_soc_emerg_start')|float(15)
             and states('sensor.solarflow_total_solar_input')|float(0) < 150 }}
        for: "00:10:00"
      - trigger: template
        id: "stable_start_u2"
        value_template: >
          {{ is_number(states('sensor.solarflow_2_battery_level')) 
             and states('sensor.solarflow_2_battery_level')|float(0) < states('input_number.zendure_conf_soc_emerg_start')|float(15)
             and states('sensor.solarflow_total_solar_input')|float(0) < 150 }}
        for: "00:10:00"

    conditions:
      - condition: state
        entity_id: input_boolean.zendure_auto_mode
        state: "on"
    actions:
      - variables:
          s1: "{{ states('sensor.solarflow_1_battery_level')|float(-1) }}"
          s2: "{{ states('sensor.solarflow_2_battery_level')|float(-1) }}"
          valid_socs: >
            {% set list = [] %}
            {% if s1 >= 0 %}{% set list = list + [s1] %}{% endif %}
            {% if s2 >= 0 %}{% set list = list + [s2] %}{% endif %}
            {{ list }}
          min_soc_val: "{{ valid_socs | min if valid_socs | length > 0 else 100 }}"
          solar: "{{ states('sensor.solarflow_total_solar_input')|float(0) }}"
          start_lim: "{{ states('input_number.zendure_conf_soc_emerg_start')|int }}"
          stop_lim: "{{ states('input_number.zendure_conf_soc_emerg_stop')|int }}"
      
      - choose:
          # V36: Start only if stable trigger fired OR manually if somehow missed (fallback)
          - conditions: "{{ (trigger.id in ['stable_start_u1', 'stable_start_u2', 'periodic']) and is_state('input_boolean.zendure_emergency_charge', 'off') and (min_soc_val < start_lim) and (solar < 150) }}"
            sequence:
              - action: input_boolean.turn_on
                target: { entity_id: input_boolean.zendure_emergency_charge }
              - action: notify.send_message
                target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
                data: 
                  message: "🔋 *Zendure Notladung*\nGestartet (Min SoC: {{ min_soc_val|round(0) }}% < {{ start_lim }}%)."
          
          # V45: Stop Logic Fix - Periodic checks ONLY SoC, Solar checks ONLY stable trigger
          - conditions: >
              {{ is_state('input_boolean.zendure_emergency_charge','on') and (
                   (trigger.id in ['stop_min_soc', 'periodic'] and (min_soc_val >= stop_lim))
                   or (trigger.id == 'solar_stable_stop')
                 ) }}
            sequence:
              - action: input_boolean.turn_off
                target: { entity_id: input_boolean.zendure_emergency_charge }
              - action: notify.send_message
                target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
                data: { message: "✅ *Zendure Notladung*\nBeendet." }

  # --- 6.9 SEASON MANAGER (SPORT SETTINGS & FIXED 14D CALIB) ---
  - alias: "Zendure: Season Manager"
    id: "zendure_season_manager_dual"
    triggers:
      - trigger: time
        at: "04:00:00"
      - trigger: homeassistant
        event: start
    actions:
      - choose:
          # WINTER (Oktober - März)
          - conditions: "{{ now().month >= 10 or now().month < 4 }}"
            sequence:
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_soc_off }
                data: { value: 20 }
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_soc_bypass }
                data: { value: 25 }
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_soc_emerg_start }
                data: { value: 15 }
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_soc_emerg_stop }
                data: { value: 25 }
              # V37.1: FIXED 14 Days (User Request)
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_calib_days }
                data: { value: 14 }

          # SOMMER (April - September)
          - conditions: "{{ now().month >= 4 and now().month < 10 }}"
            sequence:
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_soc_off }
                data: { value: 10 }
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_soc_bypass }
                data: { value: 15 }
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_soc_emerg_start }
                data: { value: 7 }
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_soc_emerg_stop }
                data: { value: 9 }
              # V37.1: FIXED 14 Days (User Request)
              - action: input_number.set_value
                target: { entity_id: input_number.zendure_conf_calib_days }
                data: { value: 14 }
      
      # V36: Base settings (Dynamic Hysteresis is handled in Control Loop)
      - action: input_number.set_value
        target: { entity_id: input_number.zendure_conf_grid_bias }
        data: { value: 10 }
      - action: input_number.set_value
        target: { entity_id: input_number.zendure_conf_hysteresis }
        data: { value: 10 }
      - action: input_number.set_value
        target: { entity_id: input_number.zendure_conf_min_change }
        data: { value: 5 }

      - delay: "00:00:05"
      # V39: Double-Tap SmartMode ON (SWITCH PROTOCOL "ON")
      - parallel:
        - if: 
            - condition: template
              value_template: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
          then:
            - action: mqtt.publish
              data: { topic: "Zendure/switch/HUB1_SERIAL_NUMBER/smartMode/set", payload: "ON", qos: 1 }
        - if: 
            - condition: template
              value_template: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
          then:
            - action: mqtt.publish
              data: { topic: "Zendure/switch/HUB2_SERIAL_NUMBER/smartMode/set", payload: "ON", qos: 1 }
      - delay: "00:00:02" # Safety Delay
      - parallel:
        - if: 
            - condition: template
              value_template: "{{ states('sensor.solarflow_1_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
          then:
            - action: mqtt.publish
              data: { topic: "Zendure/switch/HUB1_SERIAL_NUMBER/smartMode/set", payload: "ON", qos: 1 }
        - if: 
            - condition: template
              value_template: "{{ states('sensor.solarflow_2_status_raw') not in ['unavailable', 'unknown', 'FAULT', 'ERROR'] }}"
          then:
            - action: mqtt.publish
              data: { topic: "Zendure/switch/HUB2_SERIAL_NUMBER/smartMode/set", payload: "ON", qos: 1 }

  # --- 6.10 MONITORING ---
  - alias: "Zendure: Monitoring"
    id: "zendure_monitoring_dual"
    triggers:
      - trigger: template
        id: "shelly_fail"
        value_template: "{{ not is_number(states('sensor.shellypro3em_SHELLY_ID_total_active_power')) }}"
        for: "00:00:30"
      - trigger: template
        id: "shelly_ok"
        value_template: "{{ is_number(states('sensor.shellypro3em_SHELLY_ID_total_active_power')) }}"
        for: "00:01:00"
      - trigger: state
        entity_id: sensor.solarflow_1_status_raw
        to: "unavailable"
        for: "00:03:00" # V40: Reduced to 3m (total 5m with expiry)
        id: "u1_fail"
      - trigger: state
        entity_id: sensor.solarflow_2_status_raw
        to: "unavailable"
        for: "00:03:00" # V40: Reduced to 3m
        id: "u2_fail"
    actions:
      - choose:
          - conditions: "{{ trigger.id == 'shelly_fail' }}"
            sequence:
              - action: persistent_notification.create
                data: { title: "⚠️ Zendure Failsafe", message: "Netzdaten fehlen (Shelly offline). Grundlast aktiv.", notification_id: "sf_failsafe" }
          - conditions: "{{ trigger.id == 'shelly_ok' }}"
            sequence:
              - action: persistent_notification.dismiss
                data: { notification_id: "sf_failsafe" }
          - conditions: "{{ trigger.id == 'u1_fail' }}"
            sequence:
              - action: notify.send_message
                target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
                data: { message: "⚠️ *Zendure Warnung*\nUnit 1 ist offline/nicht erreichbar." }
          - conditions: "{{ trigger.id == 'u2_fail' }}"
            sequence:
              - action: notify.send_message
                target: { entity_id: notify.telegram_bot_YOUR_TELEGRAM_SERVICE }
                data: { message: "⚠️ *Zendure Warnung*\nUnit 2 ist offline/nicht erreichbar." }
